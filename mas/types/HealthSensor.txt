:- dynamic my_instance_name/1.
my_instance_name('None').

get_agent_name(Name) :- my_instance_name(Value), Value == 'None'. 
get_agent_nameI(_) :>
    setof(Base,
        Path^(
            source_file(_, Path),
            sub_atom(Path, _, _, _, 'HealthSensor'),
            pure_base_name(Path, Base)
        ),
        Bases),
    Bases = [First | _],
    write(First), nl,
    retractall(my_instance_name(_)),
    assertz(my_instance_name(First)).


pure_base_name(Path, Base) :-
    atom(Path),
    atom_chars(Path, CharList),
    findall(Pos, nth0(Pos, CharList, '/'), SlashPositions),
    findall(Pos, nth0(Pos, CharList, '.'), PointPositions),
    last(SlashPositions, LastSlashPos),
    last(PointPositions, LastPointPos),
    StartPos is LastSlashPos + 1,
    Length is LastPointPos - StartPos,
    sub_atom(Path, StartPos, Length, _, Base).



:- dynamic ward/1.
ward('None').
set_ward :- ward(Val), Val == 'None', my_instance_name(Value), Value \= 'None'.
set_wardI :> 
    my_instance_name(Val),
    atom_chars(Val, CharList),
    findall(Pos, nth0(Pos, CharList, '_'), UnderScorePositions),
    (UnderScorePositions = [] -> 
        Base = Val
    ; 
        UnderScorePositions = [FirstUnderScorPos|_], 
        last(UnderScorePositions, LastUnderScorPos),
        StartPos is FirstUnderScorPos + 1,
        Length is LastUnderScorPos - FirstUnderScorPos - 1,
        sub_atom(Val, StartPos, Length, _, Base)
    ),
    retractall(ward(_)),
    assertz(ward(Base)),
    write('Ward name: '), write(Base), nl.


:- dynamic p_name/1.
p_name('None').
set_p_name :- p_name(Val), Val == 'None', my_instance_name(Value), Value \= 'None'.
set_p_nameI :> 
    my_instance_name(Val),
    atom_chars(Val, CharList),
    findall(Pos, nth0(Pos, CharList, '_'), UnderScorePositions),
    ( UnderScorePositions = [] ->
        Pname = Val
    ;
        last(UnderScorePositions, LastUnderScorPos),
        Start is LastUnderScorPos + 1,
        sub_atom(Val, Start, _, 0, Pname)
    ),
    retractall(p_name(_)),
    assertz(p_name(Pname)),
    write('Patient name: '), write(Pname),nl.

:- dynamic config/1.
config(0).
final_config_output :- config(A),A == 0, p_name(Pname), Pname \= 'None', ward(Wname), Wname \= 'None',retractall(config(_)), assertz(config(1)).
final_config_outputI :> write('End configuration'),nl.



trashold_hr(180).

trashold_o(89).

:- dynamic patient_taken_in_charge/1.
patient_taken_in_charge(0).

new_hrE(Patient,HR) :> critical_hr_out(Patient,HR).
new_ooE(Patient,OO) :> critical_oo_out(Patient,OO).


critical_hr_out(Patient,HR) :-  patient_taken_in_charge(B), B == 0,
                                trashold_hr(V), HR >= V,  write(Patient), write(' has a high hr: '), write(HR),nl,
                                ward(WardName), config(A), A == 1, p_name(Pname),
                                atom_concat('Ward_', WardName, InstanceWardName),
                                my_instance_name(InstanceName),
                                write('from: '), write(InstanceName),nl,
                                write('to: '), write(InstanceWardName),nl,
                                messageA(InstanceWardName,send_message(alarm('high_hr',WardName,Pname),InstanceName)).



critical_oo_out(Patient,OO) :-  patient_taken_in_charge(B), B == 0,
                                trashold_o(V), V > OO, write(Patient), write(' has a low SpO2: '), write(OO),nl,
                                ward(WardName),config(A), A == 1 ,p_name(Pname),
                                atom_concat('Ward_', WardName, InstanceWardName),
                                my_instance_name(InstanceName),
                                write('from: '), write(InstanceName),nl,
                                write('to: '), write(InstanceWardName),nl,
                                messageA(InstanceWardName,send_message(alarm('low_o2',WardName,Pname),InstanceName)).

taking_charge_emergencyE :> write('Stop sending: emergy handled'),nl, retractall(patient_taken_in_charge(_)), assertz(patient_taken_in_charge(1)).

emergency_handledE :> ward(Ward_name),  format('Emergency handled by ward ~w~n', [Ward_name]),retractall(patient_taken_in_charge(_)), assertz(patient_taken_in_charge(0)).