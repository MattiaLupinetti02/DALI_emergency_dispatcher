:- dynamic met/1.
:- dynamic wards/1.
:- dynamic equipe_read/1.
:- dynamic config/1. 
config(0).
equipe_read(0).
met(0).
wards([]).

shutdownE :>
    write('Shutting down agent...'), nl,
    halt.

read_wardsI :>  open('reparti', read, Stream), 
                read_loop(Stream),
                close(Stream),
                retractall(equipe_read(_)),
                assertz(equipe_read(1)),
                wards(WardsList),
                write('Ward list:'),
                write(WardsList),nl.

read_wards :- equipe_read(A), A == 0. read_loop(Stream) :- 
                                                            read(Stream, Termine),
                                                            ( 
                                                                    Termine == end_of_file -> true 
                                                                ; 
                                                                    Termine = reparto(NomeReparto, Lista),
                                                                    ( wards(WardsList), append(WardsList,[NomeReparto], Temp), 
                                                                    retractall(wards(_)),
                                                                    assertz(wards(Temp)) 
                                                                    ; true 
                                                            ),
                                                            read_loop(Stream) ).

:- dynamic pending_req/2.
:- dynamic pending_req_timer/4.
:- dynamic hr_requests/1.
:- dynamic to_send/3.
hr_requests([]).
select_needy(List, Result) :-
                                findall(Key-Value, (member(Key-Value, List), Value > 0), Result).

human_resource_requestE(Nurses,N,Doctors,D,Resuscitators,R, From, Patient) :>
                                                                                equipe_read(A), A == 1,
                                                                                write('Request for HR for the patient: '), write(Patient), write(' from the ward: '), write(From), nl,
                                                                                List = ['Nurses'-N,'Doctors'-D,'Resuscitators'-R],
                                                                                hr_requests(Old),
                                                                                \+member(From-[Patient-Vals],Old ),
                                                                                select_needy(List, Result),
                                                                                append(Old, [From-[Patient-Result]], Requests),
                                                                                write('Current requests: '),write(Requests),nl,
                                                                                retractall(hr_requests(_)),
                                                                                assertz(hr_requests(Requests)),

                                                                                send_req(Requests, From, Patient),
                                                                            
                                        
                                                                                messageA('Logger',
                                                                                    send_message(
                                                                                        human_resource_request(N,D,R,From,Patient),
                                                                                        'HRCoordinator_instance')
                                                                                    ),
                                                                                
                                                                                write('Request timeout started for HR: '),write(List),
                                                                                write('for the patient: '),write(Patient),write(' from the ward: '),
                                                                                write(From),nl.
send_req(Requests, From, Patient) :- 
                                    (   member(From-Value, Requests), 
                                        member(Patient-Requested_equipe, Value) ->
                                        wards(Wards),
                                        assertz(to_send(Patient,From,Wards)),
                                        assertz(sended_req(Receiver_Ward))                                                                    
                                        ;true 
                                    ). 

send_req_to_wards(Ward,Requested_equipe, From,Patient) :-   
                                                            
                                                            to_send(Patient,From,Wards),
                                                            write(Wards),
                                                            ( Wards \= [] ->
                                                                last(Wards,Ward),
                                                                select(Ward,Wards,Temp),
                                                                retract(to_send(Patient,From,Wards)),
                                                                assertz(to_send(Patient,From,Temp)),
                                                                \+pending_req_timer(From,Ward,Patient,_),
                                                                hr_requests(Requests),
                                                                member(From-Values,Requests),
                                                                member(Patient-Requested_equipe,Values)
                                                            ;   (
                                                                    assertz(emergency_timer(From,Patient,2)),nl,retractall(to_send(Patient,From,_))
                                                                    
                                                                )
                                                            ).


send_req_to_wardsI(Ward, Request, From, Patient) :> ground(Request),
                                                            
                                                            ground(From),
                                                            atom_concat('Ward_', Ward, Dest),
                                                            write('Dest: '),write(Dest),nl,
                                                            write('From: '),write(From),nl,
                                                            ( 
                                                                Dest == From -> true 
                                                                ;   get_value('Nurses',Request,0,N),
                                                                    get_value('Doctors',Request,0,D),
                                                                    get_value('Resuscitators',Request,0,R),
                                                                    assertz(pending_req_timer(From,Dest,Patient,3)),

                                                                    messageA(
                                                                                Dest,
                                                                                send_message( human_resource_request('Nurses',N,'Doctors',D,'Resuscitators',R, From, Patient),
                                                                                'HRCoordinator_instance' ) 

                                                                            ) 
                                                            ).

:- dynamic emergency_timer/3.
:- dynamic sended_req/1.

sending_tick(Requests, From, Dest,Patient,T) :- hr_requests(Requests),pending_req_timer(From,Dest,Patient,T).

sending_tickI(Requests, From, Dest,Patient,T):>
    
    write('[sending_tick] Patient '), write(Patient),
    write(' remaining: '), write(T), nl,
    write(From),nl,write(Requests),nl,
    (
        T > 1 ->
            T1 is T - 1,
            retractall(pending_req_timer(From,Dest,Patient,_)),
            assertz(pending_req_timer(From,Dest,Patient,T1))
        ;
            
            member(From-P_list,Requests),
            write(pending_req_timer(From,Dest,Patient,T)),nl,
            write(send_req(Requests, From, Patient)),nl,
            retract(pending_req_timer(From,Dest,Patient,_)),
            write('[END TIMEOUT SENDING REQUEST] for the patient: '),write(Patient),
            send_req(Requests, From, Patient)
    ).

timeout_tick(Requests, From, Patient,T) :-  emergency_timer(From,Patient,T),
                                    hr_requests(Requests),
                                    member(From-Value,Requests),
                                    member(Patient-Req,Value).

timeout_tickI(Requests, From, Patient,T):>
    
    write('[timeout_tick] Patient '), write(Patient),
    write(' remaining: '), write(T), nl,
    (
        T > 1 ->
            T1 is T - 1,
            retractall(emergency_timer(From,Patient,_)),
            assertz(emergency_timer(From,Patient,T1))
        ;
            retractall(emergency_timer(From,Patient,_)),
            write('[END TIMEOUT HR REQUEST] for the patient: '),
            write(Patient), nl,
            send_req(Requests, From, Patient)
    ).


get_value(Chiave, ListaCoppie, Default, Valore) :- (member(Chiave-Valore, ListaCoppie) -> true ; Valore = Default ). 

human_resource_lendingE(Patient,Receiver_Ward,Sender_Ward) :>   
                                                                retractall(emergency_timer(Receiver_Ward,Patient,_)),
                                                                retractall(to_send(Patient,Receiver_Ward,_)),
                                                                retractall(pending_req_timer(Receiver_Ward,_,Patient,_)),
                                                                hr_requests(Requests),
                                                                member(Receiver_Ward-Value, Requests), 
                                                                member(Patient-Requested_equipe, Value),
                                                                select(Patient-Requested_equipe, Value,New_req_list),
                                                                write('=====HR lended by Ward: '),write(Sender_Ward),write(' to '),write(Receiver_Ward),write('====='),nl,
                                                                get_value('Nurses',Requested_equipe,0,N),
                                                                get_value('Doctors',Requested_equipe,0,D),
                                                                get_value('Resuscitators',Requested_equipe,0,R),

                                                                messageA(
                                                                    Receiver_Ward,
                                                                    send_message(
                                                                        human_resource_reply(N,D,R,Receiver_Ward,Sender_Ward,Patient),
                                                                        'HRCoordinator_instance')
                                                                ),messageA('Logger',
                                                                    send_message(
                                                                        human_resource_lending(N,D,R,Receiver_Ward,Sender_Ward,Patient),
                                                                        'HRCoordinator_instance')
                                                                ).

human_resource_restitutionE(N,D,R,Patient,Receiver_Ward,Sender_Ward) :> 
                                                                        hr_requests(Req),

                                                                        write('=====HR restitution to the Ward to '),write(Sender_Ward),write(' from '),write(Receiver_Ward),write('====='),nl,
                                                                        write(Receiver_Ward),nl,
                                                                        
                                                                        member(Receiver_Ward-Ward_receiver_map, Req),
                                                                        
                                                                        
                                                                        select(Patient-_,Ward_receiver_map,New_req_list),
                                                                        retractall(hr_requests(Req)),
                                                                        assertz(hr_requests(New_req_list)),
                                                                        
                                                                        write('HR again out of the ward: '),write(New_req_list),nl,
                                                                        write('====== RELEASED: '), write('N ' ), write(N), write(' D '), write(D), write(' R '), write(R),nl,
                                                                        
                                                                        messageA(Sender_Ward,send_message(human_resource_restore_ward(N,D,R), 'HRCoordinator_instance')),
                                                                        
                                                                        write('====== From '),write(Sender_Ward),write(' ======'),nl,
                                                                        retractall(sended_req(Receiver_Ward)),
                                                                        messageA('Logger',
                                                                            send_message(
                                                                                human_resource_restitution(N,D,R,Patient,Receiver_Ward,Sender_Ward),
                                                                                'HRCoordinator_instance')
                                                                        ).


stop_send_reqE(Receiver_Ward):> 
                                hr_requests(Req),
                                (sended_req(Receiver_Ward)->
                                    write('A HR request for '),write(Receiver_Ward),write(' already sended - impossible to release other request from this ward'),nl

                                    ;
                                    
                                    write('All HR request for '),write(Receiver_Ward),write(' have been released '),nl,
                                    member(Receiver_Ward-Ward_receiver_map, Req),
                                    select(Receiver_Ward-Ward_receiver_map, Req,New_req_list),
                                    retractall(hr_requests(Req)),
                                    assertz(hr_requests(New_req_list)),
                                    retractall(emergency_timer(Receiver_Ward,_,_))
                                ).