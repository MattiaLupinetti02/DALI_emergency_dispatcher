:- dynamic met/1.
:- dynamic wards/1.
:- dynamic equipe_read/1.
:- dynamic config/1. 
config(0).
equipe_read(0).
met(0).
wards([]).

shutdownE :>
    write('Shutting down agent...'), nl,
    halt.

read_wardsI :>  open('reparti', read, Stream), 
                read_loop(Stream),
                close(Stream),
                retractall(equipe_read(_)),
                assertz(equipe_read(1)),
                wards(WardsList),
                write('Ward list:'),
                write(WardsList),nl.

read_wards :- equipe_read(A), A == 0. read_loop(Stream) :- 
                                                            read(Stream, Termine),
                                                            ( 
                                                                    Termine == end_of_file -> true 
                                                                ; 
                                                                    Termine = reparto(NomeReparto, Lista),
                                                                    ( wards(WardsList), append(WardsList,[NomeReparto], Temp), 
                                                                    retractall(wards(_)),
                                                                    assertz(wards(Temp)) 
                                                                    ; true 
                                                            ),
                                                            read_loop(Stream) ).


:- dynamic hr_requests/1.
hr_requests([]).
select_needy(List, Result) :-
                                findall(Key-Value, (member(Key-Value, List), Value > 0), Result).

human_resource_requestE(Nurses,N,Doctors,D,Resuscitators,R, From, Patient) :>
                                                                                equipe_read(A), A == 1,
                                                                                List = ['Nurses'-N,'Doctors'-D,'Resuscitators'-R],
                                                                                select_needy(List, Result), hr_requests(Old),
                                                                                append(Old, [From-[Patient-Result]], Requests),
                                                                                retractall(hr_requests(_)),
                                                                                assertz(hr_requests(Requests)),
                                                                                send_req(Requests, From, Patient),
                                                                                messageA('Logger',
                                                                                    send_message(
                                                                                        human_resource_request(N,D,R,From,Patient),
                                                                                        'HRCoordinator_instance')
                                                                                    ),
                                                                                assertz(emergency_timer(From,Patient,2)),
                                                                                write('Request timeout started for HR: '),write(List),
                                                                                write('for the patient: '),write(Patient),write(' from the ward: '),
                                                                                write(From),nl.
send_req(Requests, From, Patient) :- 
                                    (   member(From-Value, Requests), 
                                        member(Patient-Requested_equipe, Value) ->
                                        wards(Wards),
                                        send_req_to_wards(Wards, Requested_equipe, From, Patient) 
                                        ;true 
                                    ). 


send_req_to_wards([], _, _,_).
send_req_to_wards([Ward | Tail], Request, From, Patient) :- ground(Request),
                                                            ground(From),
                                                            atom_concat('Ward_', Ward, Dest),
                                                            ( 
                                                                Dest == From -> true 
                                                                ;   get_value('Nurses',Request,0,N),
                                                                    get_value('Doctors',Request,0,D),
                                                                    get_value('Resuscitators',Request,0,R),
                                                                    write('Sending HR request to: '),write(Dest),nl,
                                                                    messageA(
                                                                                Dest,
                                                                                send_message( human_resource_request('Nurses',N,'Doctors',D,'Resuscitators',R, From, Patient),
                                                                                'HRCoordinator_instance' ) 
                                                                            ) 
                                                            ),send_req_to_wards(Tail, Request, From, Patient).

:- dynamic emergency_timer/3.

tick(Requests, From, Patient,T) :-  emergency_timer(From,Patient,T),
                                    hr_requests(Requests),
                                    member(From-Value,Requests),
                                    member(Patient-Req,Value).

tickI(Requests, From, Patient,T):>
    
    write('[TICK] Patient '), write(Patient),
    write(' remaining: '), write(T), nl,
    (
        T > 1 ->
            T1 is T - 1,
            retractall(emergency_timer(From,Patient,_)),
            assertz(emergency_timer(From,Patient,T1))
        ;
            retractall(emergency_timer(From,Patient,_)),
            write('[END TIMEOUT HR REQUEST] for the patient: '),
            write(Patient), nl,
            send_req(Requests, From, Patient)
    ).


get_value(Chiave, ListaCoppie, Default, Valore) :- (member(Chiave-Valore, ListaCoppie) -> true ; Valore = Default ). 

human_resource_lendingE(Patient,Receiver_Ward,Sender_Ward) :>   
                                                                retractall(emergency_timer(Receiver_Ward,Patient,_)),
                                                                hr_requests(Requests),
                                                                member(Receiver_Ward-Value, Requests), 
                                                                member(Patient-Requested_equipe, Value),
                                                                write('=====HR lended by Ward: '),write(Sender_Ward),write(' to '),write(Receiver_Ward),write('====='),nl,
                                                                get_value('Nurses',Requested_equipe,0,N),
                                                                get_value('Doctors',Requested_equipe,0,D),
                                                                get_value('Resuscitators',Requested_equipe,0,R),
                                                                messageA(
                                                                    Receiver_Ward,
                                                                    send_message(
                                                                        human_resource_reply(N,D,R,Receiver_Ward,Sender_Ward,Patient),
                                                                        'HRCoordinator_instance')
                                                                ),messageA('Logger',
                                                                    send_message(
                                                                        human_resource_lending(N,D,R,Receiver_Ward,Sender_Ward,Patient),
                                                                        'HRCoordinator_instance')
                                                                ).

human_resource_restitutionE(N,D,R,Patient,Receiver_Ward,Sender_Ward) :> 
                                                                        hr_requests(Req),
                                                                        write('=====HR restitution to the Ward to '),write(Sender_Ward),write(' from '),write(Receiver_Ward),write('====='),nl,
                                                                        member(Receiver_Ward-Ward_receiver_map, Req),
                                                                        select(Patient-_,Ward_receiver_map,New_req_list),
                                                                        retractall(hr_requests(Req)),
                                                                        assertz(hr_requests(New_req_list)),
                                                                        write('HR again out of the ward: '),write(New_req_list),nl,
                                                                        messageA(Sender_Ward,send_message(human_resource_restore_ward(N,D,R), 'HRCoordinator_instance')),
                                                                        messageA('Logger',
                                                                            send_message(
                                                                                human_resource_restitution(N,D,R,Patient,Receiver_Ward,Sender_Ward),
                                                                                'HRCoordinator_instance')
                                                                        ).


stop_send_reqE(Receiver_Ward):> hr_requests(Req),
                                write(Req),nl,
                                member(Receiver_Ward-Ward_receiver_map, Req),
                                select(Receiver_Ward-Ward_receiver_map, Req,New_req_list),
                                retractall(hr_requests(Req)),
                                assertz(hr_requests(New_req_list)),
                                write(New_req_list),nl,
                                retractall(emergency_timer(Receiver_Ward,_,_)),
                                write('diocanide'),nl.