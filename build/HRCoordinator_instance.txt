:- dynamic met/1.
:- dynamic wards/1.
:- dynamic equipe_read/1.
:- dynamic config/1. 
config(0).
equipe_read(0).
met(0).
wards([]).
read_wardsI :> open('reparti', read, Stream), read_loop(Stream), close(Stream), retractall(equipe_read(_)), assertz(equipe_read(1)), wards(WardsList),write(WardsList),nl.

read_wards :- equipe_read(A), A == 0. read_loop(Stream) :- 
                                                            read(Stream, Termine),
                                                            ( 
                                                                    Termine == end_of_file -> true 
                                                                ; 
                                                                    Termine = reparto(NomeReparto, Lista),
                                                                    ( wards(WardsList), append(WardsList,[NomeReparto], Temp), 
                                                                    retractall(wards(_)),
                                                                    assertz(wards(Temp)) 
                                                                    ; true 
                                                            ),
                                                            read_loop(Stream) ).


:- dynamic hr_requests/1.
hr_requests([]).
select_needy(List, Result) :-
                                findall(Key-Value, (member(Key-Value, List), Value > 0), Result).

human_resource_requestE(Nurses,N,Doctors,D,Resuscitators,R, From, Patient) :>
                                                                                equipe_read(A), A == 1,
                                                                                List = ['Nurses'-N,'Doctors'-D,'Resuscitators'-R],
                                                                                select_needy(List, Result), hr_requests(Old),
                                                                                append(Old, [From-[Patient-Result]], Requests),
                                                                                retractall(hr_requests(_)),
                                                                                assertz(hr_requests(Requests)),
                                                                                write(Requests),nl, send_req(Requests, From, Patient).
send_req(Requests, From, Patient) :- 
                                    (   member(From-Value, Requests), 
                                        member(Patient-Requested_equipe, Value) ->
                                        wards(Wards),
                                        write('nel ramo true di send_req'),nl, write(From),nl, write(Patient),nl,
                                        send_req_to_wards(Wards, Requested_equipe, From, Patient) 
                                        ;true 
                                    ). 
send_req_to_wards([], _, _,_).
send_req_to_wards([Ward | Tail], Request, From, Patient) :- ground(Request),
                                                            ground(From),
                                                            atom_concat('Ward_', Ward, Dest),
                                                            ( 
                                                                Dest == From -> true 
                                                                ;   get_value('Nurses',Request,0,N),
                                                                    get_value('Doctors',Request,0,D),
                                                                    get_value('Resuscitators',Request,0,R),
                                                                    write(Dest),
                                                                    messageA(
                                                                                Dest,
                                                                                send_message( human_resource_request('Nurses',N,'Doctors',D,'Resuscitators',R, From, Patient),
                                                                                'HRCoordinator_instance' ) 
                                                                            ) 
                                                            ),send_req_to_wards(Tail, Request, From, Patient).

get_value(Chiave, ListaCoppie, Default, Valore) :- (member(Chiave-Valore, ListaCoppie) -> true ; Valore = Default ). 

human_resource_lendingE(Patient,Receiver_ward,Sender_Ward) :>   hr_requests(Requests),
                                                                write('Old requests: '), write(Requests),nl,
                                                                write(' Rec_Ward: '),write(Receiver_ward),nl,
                                                                member(Receiver_ward-Value, Requests), 
                                                                member(Patient-Requested_equipe, Value),
                                                                write(Requested_equipe),
                                                                get_value('Nurses',Requested_equipe,0,N),
                                                                get_value('Doctors',Requested_equipe,0,D),
                                                                get_value('Resuscitators',Requested_equipe,0,R),
                                                                write('inviati'), write(' Patient: '),write(Patient),nl,
                                                                write(' Rec_Ward2: '),write(Receiver_ward),nl,
                                                                write(' Send_Ward: '), write(Sender_Ward),nl,
                                                                write(' Nurses: '), write(N),nl,
                                                                write(' Doctors: '), write(D),nl,
                                                                write(' Resuscitators: '), write(R),nl,
                                                                write(' Patient: '), write(Patient),nl,
                                                                messageA(
                                                                    Receiver_ward,
                                                                    send_message(
                                                                        human_resource_reply(N,D,R,Receiver_ward,Sender_Ward,Patient),
                                                                        'HRCoordinator_instance')
                                                                ).

human_resource_restitutionE(N,D,R,Receiver_Ward,Sender_Ward) :> write('ricevuto human_resource_restitutionE(N,D,R,Receiver_Ward,Sender_Ward)').